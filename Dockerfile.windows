# escape=`

# Minimal Windows Docker image with agent CLIs for sandboxes
# Base: Windows Server Core (build) -> Nano Server (runtime)
# Agents: OpenCode, Claude Code, Goose, Codex, Cursor CLI

# =============================================================================
# Build Stage - Use Server Core for PowerShell and build tools
# =============================================================================
FROM mcr.microsoft.com/windows/servercore:ltsc2022 AS builder

SHELL ["powershell", "-Command", "$ErrorActionPreference = 'Stop'; $ProgressPreference = 'SilentlyContinue';"]

# Create directories
RUN New-Item -ItemType Directory -Force -Path C:\nodejs; `
    New-Item -ItemType Directory -Force -Path C:\agents; `
    New-Item -ItemType Directory -Force -Path C:\agents\npm-global

# Install Node.js LTS (required for Claude Code, Codex, OpenCode)
ENV NODE_VERSION=20.11.1
RUN Invoke-WebRequest -Uri "https://nodejs.org/dist/v$env:NODE_VERSION/node-v$env:NODE_VERSION-win-x64.zip" -OutFile C:\nodejs.zip; `
    Expand-Archive C:\nodejs.zip -DestinationPath C:\; `
    Move-Item -Path "C:\node-v$env:NODE_VERSION-win-x64\*" -Destination C:\nodejs -Force; `
    Remove-Item "C:\node-v$env:NODE_VERSION-win-x64" -Force; `
    Remove-Item C:\nodejs.zip -Force

# Add Node.js to PATH for npm postinstall scripts (include PowerShell path)
ENV PATH="C:\nodejs;C:\Windows\System32\WindowsPowerShell\v1.0;C:\Windows\system32;C:\Windows"

# Configure npm to install global packages in our agents directory
RUN C:\nodejs\npm.cmd config set prefix C:\agents\npm-global

# =============================================================================
# Agent CLIs Installation
# =============================================================================

# OpenCode - AI coding assistant
# https://opencode.ai
RUN C:\nodejs\npm.cmd install -g opencode-ai

# Claude Code - Anthropic's AI coding assistant
# https://docs.anthropic.com/claude-code
RUN C:\nodejs\npm.cmd install -g @anthropic-ai/claude-code

# Codex - OpenAI's coding assistant
# https://github.com/openai/codex
RUN C:\nodejs\npm.cmd install -g @openai/codex

# Goose - AI developer agent (direct binary download)
# https://github.com/block/goose
# Note: Goose may not have Windows releases - this step is optional
RUN [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; `
    try { `
        $releases = Invoke-RestMethod -Uri 'https://api.github.com/repos/block/goose/releases/latest'; `
        $asset = $releases.assets | Where-Object { $_.name -like '*windows*.zip' -or $_.name -like '*win*.zip' } | Select-Object -First 1; `
        if ($asset) { `
            Write-Host \"Downloading Goose: $($asset.name)\"; `
            Invoke-WebRequest -Uri $asset.browser_download_url -OutFile C:\goose.zip -UseBasicParsing; `
            Expand-Archive C:\goose.zip -DestinationPath C:\goose-temp -Force; `
            $exe = Get-ChildItem -Path C:\goose-temp -Recurse -Filter 'goose.exe' | Select-Object -First 1; `
            if ($exe) { Move-Item $exe.FullName C:\agents\goose.exe -Force } `
            else { Write-Warning 'goose.exe not found in archive' }; `
            Remove-Item C:\goose.zip, C:\goose-temp -Recurse -Force -ErrorAction SilentlyContinue `
        } else { Write-Warning 'Goose Windows binary not found in releases' } `
    } catch { Write-Warning \"Goose install failed: $_\" }

# Cursor CLI - Cursor's AI agent
# https://cursor.com/cli
RUN [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; `
    Invoke-RestMethod -Uri 'https://cursor.com/install?win32=true' | Invoke-Expression; `
    $p1 = Join-Path $env:LOCALAPPDATA 'cursor-agent\agent.exe'; `
    $p2 = Join-Path $env:USERPROFILE '.local\bin\agent.exe'; `
    $p3 = 'C:\Users\ContainerAdministrator\.local\bin\agent.exe'; `
    if (Test-Path $p1) { Move-Item $p1 C:\agents\cursor-agent.exe -Force } `
    elseif (Test-Path $p2) { Move-Item $p2 C:\agents\cursor-agent.exe -Force } `
    elseif (Test-Path $p3) { Move-Item $p3 C:\agents\cursor-agent.exe -Force } `
    else { Write-Warning 'Cursor CLI not found'; New-Item -ItemType File -Path C:\agents\cursor-agent.exe -Force | Out-Null }

# =============================================================================
# Runtime Stage - Minimal Nano Server image
# =============================================================================
FROM mcr.microsoft.com/windows/nanoserver:ltsc2022

# Copy Node.js runtime
COPY --from=builder C:\nodejs C:\nodejs

# Copy installed agents
COPY --from=builder C:\agents C:\agents

# Set up PATH using setx
USER ContainerAdministrator
RUN setx /M PATH "C:\nodejs;C:\agents\npm-global;C:\agents;%PATH%"
USER ContainerUser

# Labels
LABEL org.opencontainers.image.source="https://github.com/devdone-labs/dd-agents-registry"
LABEL org.opencontainers.image.description="Minimal Windows agent CLIs image for AI coding assistants"
LABEL org.opencontainers.image.licenses="MIT"

# Set working directory
WORKDIR C:\workspace

# Verify installations
# Required: Node.js, OpenCode, Claude Code, Codex (npm-based)
# Optional: Goose, Cursor CLI (may not have Windows builds)
SHELL ["cmd", "/S", "/C"]
RUN C:\nodejs\node.exe --version && echo Node.js: OK && `
    C:\agents\npm-global\opencode.cmd --version && echo OpenCode: OK && `
    C:\agents\npm-global\claude.cmd --version && echo Claude Code: OK && `
    C:\agents\npm-global\codex.cmd --version && echo Codex: OK && `
    echo === Required agents verified === && `
    (C:\agents\goose.exe --version && echo Goose: OK || echo Goose: NOT AVAILABLE) && `
    (C:\agents\cursor-agent.exe --version && echo Cursor CLI: OK || echo Cursor CLI: NOT AVAILABLE)

# Default command - show available agents
CMD ["cmd", "/c", "echo Available agents: opencode, claude, goose, codex, cursor-agent"]
